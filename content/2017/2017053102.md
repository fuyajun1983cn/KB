/*
  title: 蓝牙5的广播消息
  sort: 2
  */

KEYWORDS: bluetooth

有着四倍的距离，两倍的速度和八倍的广播消息容量！蓝牙5正在重新定义开发人员的工具包，那么蓝牙5如何实现呢？

### 蓝牙5提供三个低功耗PHY：

- LE 1M PHY-1M / s比特率; 未编码（每个位映射到单个无线电符号）。蓝牙4.0中使用的PHY相同。
- LE Coded PHY（新）-支持具有纠错编码的1M / s符号速率。用于蓝牙5的“四倍范围”。
- LE 2M PHY（新）-2M / S符速;未编码。用于蓝牙5的“2倍速度”。

所以有了两个新的PHY，我们获得了4倍的距离和2倍的速度，但是信标的额外的消息传递能力呢？蓝牙4.0中，广告payload最多为31个八位字节。在蓝牙5中，我们通过添加其他广告渠道和新的广告PDU，将payload增加到255个八位字节。


### 附加的广告渠道

在蓝牙4.0中，所有广告都是在40 - 2.4GHz ISM频段中的3个波段完成的。使用蓝牙5，现在有两套广告渠道：主要和二级。

主要广告渠道是蓝牙4中定义的40个广告渠道中的3个原始广告渠道。而二级广告渠道使用先前为数据保留的37个固定频道。无论是使用遗留广告PDU还是新的扩展广告PDU，这些事件都将从主要渠道开始。
现在，我们来看看新的PDU。

### 新的扩展广告PDU

为了支持更多的消息传递，我们添加了扩展广告PDU。这些PDU仅是广播事件（如电子信标）：
- ADV_EXT_IND：支持不可连接（仅广播）和可扫描的定向事件

  1. 不可连接：标准信标，如定义博物馆游客是否接近展览。为用户提供模拟“飞行声音”和飞机历史的体验。
  2. 可扫描定向：如直接到博物馆中央控制器的博物馆洗手间信标广播，声明洗手间需要维护。使用扫描请求，博物馆管理员可以要求有关维护的附加信息（空的洗手液/毛巾等）。

- AUX_ADV_IND：用于在二级广告渠道上发送广告数据的第一个片段（不可连接和可扫描定向）。

- AUX_SYNC_IND：用于以固定间隔发送单向的定期广告数据。
  示例： 博物馆巴士站信标广播，当下一班公共汽车到达并离开建筑时广播。博物馆巴士站信标广播，当下一班公共汽车到达并离开建筑时广播。

- AUX_CHAIN_IND：从不完整的辅助PDU广告事件发送剩余数据。

好的，我们有二级广告渠道和新的PDU，我们的开发人员写了一个非常酷的测量接近度的应用程序。对飞机范围内的用户触发音频文件; 并提供飞机规格和历史的信息。我们如何发送额外的数据？让我们来看看。

### 新数据包格式

用于未编码PHY的链路层包格式几乎与来自蓝牙4.0的包相同：前导码，接入地址，PDU和CRC。（图1）唯一的区别是前导码的大小。当使用LE 1M PHY（蓝牙4.0 PHY）时，前导码是1个八位字节（就像蓝牙4.0），当使用LE 2M PHY（蓝牙5）时，前导码是2个八位字节。如蓝牙4.0，PDU字段分为两个要素：广告头和广告payload。

普通扩展广告事件的payload有4个元素（如下图所示）:
- 扩展头长度 - 0到63之间的值，定义扩展头的长度
- AdvMode - 定义模式（不可连接和不可扫描;可连接和不可扫描; 或不可连接和可扫描）
- 扩展头 - 定义扩展广告事件的属性
- AdvData - 包含广告数据

![06](%image_url%/2017/2017053106.png)

那么我们得到多少实际的广告数据呢？ AdvData的最大大小取决于扩展头的大小，计算方法如下：

![07](%image_url%/2017/2017053107.png)


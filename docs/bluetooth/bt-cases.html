<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-08-12 Sun 12:18 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bluetooth Cases</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Fu Yajun" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Bluetooth Cases</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org9e32d95">1. A2DP</a>
<ul>
<li><a href="#org15c393a">1.1. 03587152</a></li>
<li><a href="#org59e0eb3">1.2. 03609416</a></li>
</ul>
</li>
<li><a href="#org7362852">2. HFP</a></li>
<li><a href="#org22f4d17">3. PBAP</a>
<ul>
<li><a href="#org88458a1">3.1. 03590231</a></li>
</ul>
</li>
<li><a href="#orgf2a64f8">4. BLE</a>
<ul>
<li><a href="#orgfd37960">4.1. 03451122</a></li>
<li><a href="#org21cb353">4.2. 03565631</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org9e32d95" class="outline-2">
<h2 id="org9e32d95"><span class="section-number-2">1</span> A2DP</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org15c393a" class="outline-3">
<h3 id="org15c393a"><span class="section-number-3">1.1</span> 03587152</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li><p>
Problem Description
</p>

<p>
手机连接蓝牙耳机播放音乐，再插入线控耳机，然后拔出线控耳机，手机音乐从扬声
器输出，
</p>

<p>
预期输出结果：拔出线控耳机后，声音从蓝牙耳机输出
</p>

<p>
实际输出结果：拔出线控耳机后，声音从扬声器输出（蓝牙耳机还是为连接状态）
</p></li>

<li><p>
Facts
</p>

<p>
when plugging in the wired earbuds, AudioService called
mBluetoothProfileServiceListener's onServiceDisconnected() callback, which
disconnectA2dp() and call makeA2dpDeviceUnavailableNow() at last. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a45bad;">07-11</span> <span style="color: #a45bad;">16:42:15.636</span> <span style="color: #a45bad;">1299</span> <span style="color: #a45bad;">1817</span> D AudioService: onSetA2dpSinkConnectionState <span style="color: #7590db;">btDevice</span>=<span style="color: #a45bad;">22:22:22:33:53:D3state</span>=<span style="color: #a45bad;">0</span>
<span style="color: #a45bad;">07-11</span> <span style="color: #a45bad;">16:42:15.636</span> <span style="color: #a45bad;">1299</span> <span style="color: #a45bad;">1817</span> W AudioService: makeA2dpDeviceUnavailableNow:entry
</pre>
</div>

<p>
but at the same time, Bluetooth UI's status show that the a2dp profile is
connected.
</p></li>

<li><p>
Problem Analysis
</p>

<p>
This issue is expected behavior according to current policy, please refer
explanation in <code>ActiveDeviceManager.java</code>.
</p>

<pre class="example">
94 * 9.1) If the wired headset is still the selected output device (i.e. the
95 * active device is set to null), the Phone itself will become the output
96 * device (i.e., the active device will remain null). If music was
97 * playing, it will stop.
</pre>


<div class="figure">
<p><img src="./images/2018/2018080601.png" alt="2018080601.png" />
</p>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org59e0eb3" class="outline-3">
<h3 id="org59e0eb3"><span class="section-number-3">1.2</span> 03609416</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li><p>
Problem Description
</p>

<p>
Android P, 连接A耳机播放视频时，连接B耳机，有一瞬间声音手机外放
</p></li>

<li><p>
Facts
</p>

<p>
This is 2nd a2dp connection issue. Audio leaking on DUT spkr in
ActiveDevice switch.  
</p>

<pre class="example">

//setActiveDevice
07-31 18:06:48.781  5054  5068 W A2dpService: setActiveDevice(1C:48:F9:52:97:C9): previous is B8:AD:3E:BC:BA:A2

07-31 18:06:48.790  5054  5076 W bt_btif : btif_av_handle_event: device 1c:48:f9:52:97:c9 
07-31 18:06:48.790  5054  5076 D bt_btif : BTIF_AV_TRIGGER_HANDOFF_REQ_EVT on index 1
07-31 18:06:48.790  5054  5076 D bt_btif : current_playing for index 0: 0
07-31 18:06:48.790  5054  5076 D bt_btif : current_playing for index 1: 1
07-31 18:06:48.790  5054  5076 D bt_btif : Latest playing device index 0

07-31 18:06:48.791  5054  5076 D bt_btif : btif_av_state_started_handler event:BTIF_AV_SUSPEND_STREAM_REQ_EVT flags 0  index =0
07-31 18:06:48.791  5054  5076 W bt_btif : Suspend the AV Data channel

07-31 18:06:48.819  2478  2478 D BluetoothHeadset: setActiveDevice: 1C:48:F9:52:97:C9
07-31 18:06:48.820  5054  5078 D BluetoothActiveDeviceManager: handleMessage(MESSAGE_A2DP_ACTION_ACTIVE_DEVICE_CHANGED): device= 1C:48:F9:52:97:C9

07-31 18:06:48.826  5054  5054 I BluetoothPhonePolicy: removeAutoConnectFromA2dpSink: device B8:AD:3E:BC:BA:A2 PRIORITY_ON

//a2dp stop playback on the inactive device
07-31 18:06:48.839  5054  5118 D A2dpStateMachine: Connected process message(B8:AD:3E:BC:BA:A2): STACK_EVENT
07-31 18:06:48.839  5054  5118 D A2dpStateMachine: Connected: stack event: A2dpStackEvent {type:EVENT_TYPE_AUDIO_STATE_CHANGED, device:B8:AD:3E:BC:BA:A2, value1:STOPPED}
07-31 18:06:48.839  5054  5118 I A2dpStateMachine: Connected: stopped playing: B8:AD:3E:BC:BA:A2
07-31 18:06:48.839  5054  5118 D A2dpStateMachine: A2DP Playing state : device: B8:AD:3E:BC:BA:A2 State:PLAYING-&gt;NOT_PLAYING

07-31 18:06:48.843  1810  1810 I AudioService: setBtScoActiveDevice: B8:AD:3E:BC:BA:A2 -&gt; 1C:48:F9:52:97:C9

07-31 18:06:48.873  5054  5054 I BluetoothPhonePolicy: setAutoConnectForA2dpSink: device 1C:48:F9:52:97:C9 PRIORITY_AUTO_CONNECT
07-31 18:06:48.893  5054  5054 I BluetoothPhonePolicy: setAutoConnectForHeadset: device 1C:48:F9:52:97:C9 PRIORITY_AUTO_CONNECT



07-31 18:06:48.946   708   953 D audio_hw_primary: adev_set_parameters: enter: B8:AD:3E:BC:BA:A2=;disconnect=32
07-31 18:06:49.319   708  5234 D audio_hw_primary: adev_set_parameters: enter: B8:AD:3E:BC:BA:A2=;disconnect=128
07-31 18:06:49.321   708  5234 D audio_hw_extn: audio_extn_set_anc_parameters: anc_enabled:0
07-31 18:06:49.322   708  5234 D split_a2dp: calling BT stream close
07-31 18:06:49.322   708  5234 W bthost_ipc: audio_stream_close
07-31 18:06:49.322   708  5234 W bthost_ipc: audio_stream_close: Suspending audio stream

//audio leak
07-31 18:06:49.494   708   953 D audio_hw_primary: select_devices: out_snd_device(2: speaker) in_snd_device(0: )
07-31 18:06:49.531   708   953 D audio_hw_primary: enable_snd_device: snd_device(2: speaker)
07-31 18:06:49.531   708   953 D audio_route: Apply path: speaker


07-31 18:06:50.095   708   953 D audio_hw_primary: adev_set_parameters: enter: 1C:48:F9:52:97:C9=;connect=128

07-31 18:06:50.096   708   953 D split_a2dp:  Open A2DP output start 
07-31 18:06:50.097   708   953 D split_a2dp: calling BT stream open
07-31 18:06:50.097   708   953 W bthost_ipc: audio_stream_open
07-31 18:06:50.097   708   953 W bthost_ipc: a2dp_stream_common_init
07-31 18:06:50.097   708   953 W bthost_ipc: audio_stream_open: Success

//re-select to bt-a2dp again
07-31 18:06:50.427   708   708 D audio_hw_primary: select_devices: out_snd_device(32: bt-a2dp) in_snd_device(0: )
</pre></li>

<li><p>
Problem Analysis
</p>

<p>
between the active switch, audio route  to speaker after a short time
period.  we'd better mute it during this short time.  
</p>

<div class="org-src-container">
<pre class="src src-diff"><span style="color: #dddddd;">Subject:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">[PATCH]</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Explicitly</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">mute</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">audio</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">output</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">while</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">switching</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">A2DP</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Active</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Device</span>

<span style="color: #dddddd;">The</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">mute/unmute</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">of</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">audio</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">output</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">needed</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">during</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">A2DP</span>
<span style="color: #dddddd;">ActiveDevice</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">switch</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">to</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">avoid</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">audio</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">glitches.</span>

<span style="color: #dddddd;">Bug:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">78152025</span>
<span style="color: #dddddd;">Bug:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">110441865</span>
<span style="color: #dddddd;">Test:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Manual</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">-</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">stream</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">with</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Pandora/Spotify</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">and</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">switch</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">A2DP</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Active</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Device</span>
<span style="color: #dddddd;">Change-Id:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">I5a233460a07e0d4fffcb4e6cb208d846517f0c1e</span>
<span style="color: #bc6ec5; background-color: #373040;">---</span>

<span style="color: #dddddd;">diff</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">--git</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">a/src/com/android/bluetooth/a2dp/A2dpService.java</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">b/src/com/android/bluetooth/a2dp/A2dpService.java</span>
<span style="color: #dddddd;">index</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">0641c9f..e883227</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">100644</span>
<span style="color: #bc6ec5; background-color: #373040;">---</span><span style="color: #dc752f;"> </span><span style="color: #cbc1d5; background-color: #373040;">a/src/com/android/bluetooth/a2dp/A2dpService.java</span>
<span style="color: #bc6ec5; background-color: #373040;">+++</span><span style="color: #dc752f;"> </span><span style="color: #cbc1d5; background-color: #373040;">b/src/com/android/bluetooth/a2dp/A2dpService.java</span>
<span style="color: #bc6ec5; background-color: #373040;">@@</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">-507,7</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">+507,14</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">@@</span>
<span style="color: #dc752f;">                </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">}</span>
<span style="color: #dc752f;">                </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Make</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">sure</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Audio</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Manager</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">knows</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">previous</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Active</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">device</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">disconnected,</span>
<span style="color: #dc752f;">                </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">and</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">new</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Active</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">device</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">connected.</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                </span><span style="color: #67b11d;">//</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">Also,</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">mute</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">and</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">unmute</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">the</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">output</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">during</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">the</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">switch</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">to</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">avoid</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">audio</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">glitches.</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                </span><span style="color: #67b11d;">boolean</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">wasMuted</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">=</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">false;</span>
<span style="color: #dc752f;">                </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">if</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">(previousActiveDevice</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">!=</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">null)</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">{</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                    </span><span style="color: #67b11d;">if</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">(!mAudioManager.isStreamMute(AudioManager.STREAM_MUSIC))</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">{</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                        </span><span style="color: #67b11d;">mAudioManager.adjustStreamVolume(AudioManager.STREAM_MUSIC,</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                                                         </span><span style="color: #67b11d;">AudioManager.ADJUST_MUTE,</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">0);</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                        </span><span style="color: #67b11d;">wasMuted</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">=</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">true;</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                    </span><span style="color: #67b11d;">}</span>
<span style="color: #dc752f;">                    </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">mAudioManager.setBluetoothA2dpDeviceConnectionStateSuppressNoisyIntent(</span>
<span style="color: #dc752f;">                            </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">previousActiveDevice,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">BluetoothProfile.STATE_DISCONNECTED,</span>
<span style="color: #dc752f;">                            </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">BluetoothProfile.A2DP,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">true,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">-1);</span>
<span style="color: #bc6ec5; background-color: #373040;">@@</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">-529,6</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">+536,10</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">@@</span>
<span style="color: #dc752f;">                </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">change,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">so</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Audio</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Service</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">can</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">reset</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">accordingly</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">audio</span>
<span style="color: #dc752f;">                </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">feeding</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">parameters</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">in</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Audio</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">HAL</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">to</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Bluetooth</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">stack.</span>
<span style="color: #dc752f;">                </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">mAudioManager.handleBluetoothA2dpDeviceConfigChange(mActiveDevice);</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                </span><span style="color: #67b11d;">if</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">(wasMuted)</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">{</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                    </span><span style="color: #67b11d;">mAudioManager.adjustStreamVolume(AudioManager.STREAM_MUSIC,</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                                                     </span><span style="color: #67b11d;">AudioManager.ADJUST_UNMUTE,</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">0);</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">                </span><span style="color: #67b11d;">}</span>
<span style="color: #dc752f;">            </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">}</span>
<span style="color: #dc752f;">        </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">}</span>
<span style="color: #dc752f;">        </span><span style="color: #dc752f;"> </span>return<span style="color: #dc752f;"> </span>true;
</pre>
</div></li>

<li>2284854

<ul class="org-ul">
<li><p>
Problem Description
</p>

<p>
It takes extra 6 to 10 seconds to switch active and inactive devices on
UI setting
</p></li>

<li><p>
Facts
</p>

<p>
Repro Steps:
</p>
<ol class="org-ol">
<li>Pair with the remote Carkit device 1 (Addr 19), which support delay
reporting,</li>

<li>Pair with the remote headset device 2 (Addr 21), which not support
delay reporting. Play a song on DUT</li>

<li>Switch active device and inactive device on UI</li>
</ol></li>

<li><p>
Problem Analysis
</p>

<p>
When switch active device, current device is disconnected first and then
new device is connected. During disconnection of current device, APM will
sleep for a while to wait for output buffers to empty, after this
disconnection can be finished and new device connected. Sleep time is
about twice the output latency, which is mainly related to sink latency
for BT device.
</p>

<p>
Issue not seen on non-split mode, maybe we should check if there’s any difference for sink latency computation on non-split and split
Sink latency in AVDTP Delay reporting is calculated with 1/10 ms. For
non-split a2dp path, A2dp hal will convert 1/10 ms to ns via delay_ns = delay_report * 100000. But for split-a2dp path, 1/10 ms is treated as ms
incorrectly. So that this 2.358s sink latency send to audio HAL, the real
sink latency value should be 0.2358s. 
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org7362852" class="outline-2">
<h2 id="org7362852"><span class="section-number-2">2</span> HFP</h2>
</div>

<div id="outline-container-org22f4d17" class="outline-2">
<h2 id="org22f4d17"><span class="section-number-2">3</span> PBAP</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org88458a1" class="outline-3">
<h3 id="org88458a1"><span class="section-number-3">3.1</span> 03590231</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li><p>
Problem Description
</p>

<p>
Android P, 连接49号车载蓝牙，高概率出现无法同步联系人
</p></li>

<li><p>
Facts
</p>

<p>
from the logs, carkit only query the phonebook size on the DUT, but don't
proceed  to download it. while testing with the reference phone, it will
download the phonebook contacts.  
</p>

<p>
carkit query the phonebook size with the following request:
</p>


<div class="figure">
<p><img src="./images/2018/2018080107.png" alt="2018080107.png" />
</p>
</div>

<p>
for query, the <code>Max List Count</code> parameter is  0. 
</p>

<p>
to download the phonebook contents, carkit should sent another request with
<code>Max List Count</code> parameter not equal to 0. but it did't, that's not expected.
</p></li>

<li><p>
Problem Analysis
</p>

<p>
for this issue, we should check PBAP version and  supported feature first,
and then check other differences. 
</p>

<p>
DUT logs:
</p>


<div class="figure">
<p><img src="./images/2018/2018080105.png" alt="2018080105.png" />
</p>
</div>

<p>
Reference phone logs:
</p>


<div class="figure">
<p><img src="./images/2018/2018080106.png" alt="2018080106.png" />
</p>
</div>

<p>
there is no differene for the <b><b>Supported Repositories</b></b> attribute. 
so we need to compare the other reason.  
</p>

<p>
there maybe some other factor which let the carkit don't send download
phonebook content from the DUT. 
</p>

<p>
here is the difference:
</p>

<p>
when query phonebook size  in SIM card, DUT respond with the value of 0
when  SIM card has no contacts.
</p>


<div class="figure">
<p><img src="./images/2018/2018080108.png" alt="2018080108.png" />
</p>
</div>

<p>
while reference phone respond with the value of 1. 
</p>


<div class="figure">
<p><img src="./images/2018/2018080109.png" alt="2018080109.png" />
</p>
</div>

<p>
after change the retun value from 0 to 1, issue is  resolved.
</p>

<p>
plus, if the carkit don't  request  phonebook content from SIM card, you
can check the attribute  of <b><b>Supported Repositories</b></b> from the SDP
response to the carkit in which bit 1 represent wether <b><b>SIM card
Phonebook</b></b> is supported or not. 
</p></li>
</ul>
</div>
</div>
</div>



<div id="outline-container-orgf2a64f8" class="outline-2">
<h2 id="orgf2a64f8"><span class="section-number-2">4</span> BLE</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgfd37960" class="outline-3">
<h3 id="orgfd37960"><span class="section-number-3">4.1</span> 03451122</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li><p>
Problem Description
</p>

<p>
使用美居APP无法连接蓝牙电子秤
</p></li>

<li><p>
Facts
</p>

<p>
DUT can't search the BLE device.
</p></li>

<li><p>
Problem Analysis
</p>


<div class="figure">
<p><img src="./images/2018/2018080202.png" alt="2018080202.png" />
</p>
</div>

<p>
the format of the LE Advertising Data is  invalid, so the data is  dropped
at  the stack level.  
</p>

<p>
this valid check is introduced from Android O.  In Android N, no such
check. 
</p>

<div class="org-src-container">
<pre class="src src-diff"><span style="color: #dddddd;">Subject:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">[PATCH]</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Remove</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">bytes</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">after</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">first</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">zero</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">length</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">field</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">in</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">legacy</span>
<span style="color: #dc752f;"> </span><span style="color: #dddddd;">advertisements</span>

<span style="color: #dddddd;">This</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">for</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">compatibility</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">with</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">many</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">existing</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">old</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">devices,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">that</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">have</span>
<span style="color: #dddddd;">non-zero</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">bytes</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">after</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">zero</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">length</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">field.</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">This</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">currently</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">causing</span>
<span style="color: #dddddd;">advertisements</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">to</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">be</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">dropped,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">rendering</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">those</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">devices</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">invisible.</span>

<span style="color: #dddddd;">Bug:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">68907583</span>
<span style="color: #dddddd;">Test:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">AdvertiseDataParserTest.RemoveTrailingZerosMalformed</span>
<span style="color: #dddddd;">Change-Id:</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Ib51950f7e0c6a2771f56c6f69108fa10f2517f38</span>
<span style="color: #dddddd;">(cherry</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">picked</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">from</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">commit</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">5a290f877f5acb29e78533ad45351510cff87497)</span>
<span style="color: #bc6ec5; background-color: #373040;">---</span>
<span style="color: #dc752f;"> </span><span style="color: #dddddd;">stack/btm/btm_ble_gap.cc</span><span style="color: #dc752f;">              </span><span style="color: #dddddd;">|</span><span style="color: #dc752f;">  </span><span style="color: #dddddd;">3</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">++-</span>
<span style="color: #dc752f;"> </span><span style="color: #dddddd;">stack/include/advertise_data_parser.h</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">|</span><span style="color: #dc752f;">  </span><span style="color: #dddddd;">7</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">+------</span>
<span style="color: #dc752f;"> </span><span style="color: #dddddd;">stack/test/ad_parser_unittest.cc</span><span style="color: #dc752f;">      </span><span style="color: #dddddd;">|</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">30</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">++++++++++++++++++++++++++++--</span>
<span style="color: #dc752f;"> </span><span style="color: #dddddd;">3</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">files</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">changed,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">31</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">insertions(+),</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">9</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">deletions(-)</span>

<span style="color: #dddddd;">diff</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">--git</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">a/stack/btm/btm_ble_gap.cc</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">b/stack/btm/btm_ble_gap.cc</span>
<span style="color: #dddddd;">index</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">8037976..845c8c4</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">100644</span>
<span style="color: #bc6ec5; background-color: #373040;">---</span><span style="color: #dc752f;"> </span><span style="color: #cbc1d5; background-color: #373040;">a/stack/btm/btm_ble_gap.cc</span>
<span style="color: #bc6ec5; background-color: #373040;">+++</span><span style="color: #dc752f;"> </span><span style="color: #cbc1d5; background-color: #373040;">b/stack/btm/btm_ble_gap.cc</span>
<span style="color: #bc6ec5; background-color: #373040;">@@</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">-2014,7</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">+2014,8</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">@@</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">static</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">void</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">btm_ble_process_adv_pkt_cont(</span>
<span style="color: #dc752f;">   </span><span style="color: #dddddd;">bool</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is_start</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">=</span>
<span style="color: #dc752f;">    </span><span style="color: #dc752f;">   </span><span style="color: #dddddd;">ble_evt_type_is_legacy(evt_type)</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">&amp;&amp;</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is_scannable</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">&amp;&amp;</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">!is_scan_resp;</span>

<span style="color: #f2241f;">-</span><span style="color: #dc752f;">  </span><span style="color: #f2241f;">if</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">(is_start)</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">AdvertiseDataParser::RemoveTrailingZeros(tmp);</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">  </span><span style="color: #67b11d;">if</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">(ble_evt_type_is_legacy(evt_type))</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">    </span><span style="color: #67b11d;">AdvertiseDataParser::RemoveTrailingZeros(tmp);</span>

<span style="color: #dc752f;">   </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">We</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">might</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">have</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">send</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">scan</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">request</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">to</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">this</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">device</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">before,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">but</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">didn't</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">get</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span>
<span style="color: #dc752f;">   </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">response.</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">In</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">such</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">case</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">make</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">sure</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">data</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">is</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">put</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">at</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">start,</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">not</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">appended</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">to</span>
<span style="color: #dddddd;">diff</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">--git</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">a/stack/include/advertise_data_parser.h</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">b/stack/include/advertise_data_parser.h</span>
<span style="color: #dddddd;">index</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">473b979..fb5f7f7</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">100644</span>
<span style="color: #bc6ec5; background-color: #373040;">---</span><span style="color: #dc752f;"> </span><span style="color: #cbc1d5; background-color: #373040;">a/stack/include/advertise_data_parser.h</span>
<span style="color: #bc6ec5; background-color: #373040;">+++</span><span style="color: #dc752f;"> </span><span style="color: #cbc1d5; background-color: #373040;">b/stack/include/advertise_data_parser.h</span>
<span style="color: #bc6ec5; background-color: #373040;">@@</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">-57,12</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">+57,7</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">@@</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">class</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">AdvertiseDataParser</span><span style="color: #dc752f;"> </span><span style="color: #bc6ec5; background-color: #373040;">{</span>
<span style="color: #dc752f;">    </span><span style="color: #dc752f;">   </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">end</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">of</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">packet.</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">Otherwise</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">i.e.</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">gluing</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">scan</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">response</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">to</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">advertise</span>
<span style="color: #dc752f;">    </span><span style="color: #dc752f;">   </span><span style="color: #dddddd;">//</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">data</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">will</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">result</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">in</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">data</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">with</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">zero</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">padding</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">in</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">the</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">middle.</span>
<span style="color: #dc752f;">    </span><span style="color: #dc752f;">   </span><span style="color: #dddddd;">if</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">(len</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">==</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">0)</span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">{</span>
<span style="color: #f2241f;">-</span><span style="color: #dc752f;">        </span><span style="color: #f2241f;">size_t</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">zeros_start</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">=</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">position;</span>
<span style="color: #f2241f;">-</span><span style="color: #dc752f;">        </span><span style="color: #f2241f;">for</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">(size_t</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">i</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">=</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">position</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">+</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">1;</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">i</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">&lt;</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">ad_len;</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">i++)</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">{</span>
<span style="color: #f2241f;">-</span><span style="color: #dc752f;">          </span><span style="color: #f2241f;">if</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">(ad[i]</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">!=</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">0)</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">return;</span>
<span style="color: #f2241f;">-</span><span style="color: #dc752f;">        </span><span style="color: #f2241f;">}</span>
<span style="color: #f2241f;">-</span>
<span style="color: #f2241f;">-</span><span style="color: #dc752f;">        </span><span style="color: #f2241f;">ad.erase(ad.begin()</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">+</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">zeros_start,</span><span style="color: #dc752f;"> </span><span style="color: #f2241f;">ad.end());</span>
<span style="color: #67b11d;">+</span><span style="color: #dc752f;">        </span><span style="color: #67b11d;">ad.erase(ad.begin()</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">+</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">position,</span><span style="color: #dc752f;"> </span><span style="color: #67b11d;">ad.end());</span>
<span style="color: #dc752f;">        </span><span style="color: #dc752f;"> </span><span style="color: #dddddd;">return;</span>
<span style="color: #dc752f;">    </span><span style="color: #dc752f;">   </span>}
</pre>
</div></li>
</ul>
</div>
</div>




<div id="outline-container-org21cb353" class="outline-3">
<h3 id="org21cb353"><span class="section-number-3">4.2</span> 03565631</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li><p>
Problem Description
</p>

<p>
市场反馈：连接不上小米手环
</p></li>

<li><p>
Facts
</p>

<p>
Compare the  normal logs and abnormmal logs, 
it seems that in normal logs, we don't see Start Enpryption Procedure
happened, while in the abnormal casse, I  see host send HCI Start
Encryption command, but failed.  
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a45bad;">369</span> Command <span style="color: #a45bad;">0x2019</span> Low Energy HCI_LE_Start_Encryption <span style="color: #a45bad;">2018/7/2</span> <span style="color: #a45bad;">11:59:49.298495</span> <span style="color: #a45bad;">28</span> <span style="color: #a45bad;">32</span> <span style="color: #a45bad;">00:00:00.007311</span>
<span style="color: #a45bad;">370</span> Event <span style="color: #a45bad;">0x2019</span> Low Energy HCI_LE_Start_Encryption Command Status Success <span style="color: #a45bad;">2018/7/2</span> <span style="color: #a45bad;">11:59:49.304905</span> <span style="color: #a45bad;">4</span> <span style="color: #a45bad;">7</span> <span style="color: #a45bad;">00:00:00.006410</span>
<span style="color: #a45bad;">384</span> Event Encryption Change Connection Timeout <span style="color: #a45bad;">2018/7/2</span> <span style="color: #a45bad;">11:59:54.599536</span> <span style="color: #a45bad;">0x0002</span> <span style="color: #a45bad;">4</span> <span style="color: #a45bad;">7</span> <span style="color: #a45bad;">00:00:00.002959</span>
<span style="color: #a45bad;">385</span> Event Disconnection Complete Success <span style="color: #a45bad;">2018/7/2</span> <span style="color: #a45bad;">11:59:54.599963</span> <span style="color: #a45bad;">0x0002</span> <span style="color: #a45bad;">4</span> <span style="color: #a45bad;">7</span> <span style="color: #a45bad;">00:00:00.000427</span> 
</pre>
</div></li>

<li><p>
Problem Analysis
</p>

<p>
The snoops having the extended logging shows the SLAVE device ( other side)
did initiated START_ENCR_REQ but doesnt reply to DUT START_ENCR_RSP. 
</p>

<p>
Expected Procedure as per spec:
</p>

<p>
Slave &#x2013;&gt; START_ENC_REQ
Master&#x2013;&gt; START_ENC_RSP
Slave -&gt;&gt;START_ENC_RSP --------&#x2013;&#x2014;&gt; Here the Encryption proceedure is
complete. 
</p>

<p>
Now both side encrypted packets are expected. The slave reply in this
scenario is missing. 
</p>

<p>
After sessionKey has been calculated, the Link Layer of the slave shall
send an LL_START_ENC_REQ PDU. This packet shall be sent unencrypted, 
and the Link Layer shall be set up to receive an encrypted packet in
response. When the Link Layer of the master receives an LL_START_ENC_REQ
PDU it shall send an LL_START_ENC_RSP PDU. This PDU shall be sent encrypted
and set up to receive encrypted.
</p>

<p>
When the Link Layer of the slave receives an LL_START_ENC_RSP PDU it shall
transmit an LL_START_ENC_RSP PDU. This packet shall be sent encrypted. When
the Link Layer of the master receives the LL_START_ENC_RSP PDU, the
connection is encrypted. The Link Layer can now send LL Data PDUs and LL
Control PDUs; these PDUs will be encrypted. 
</p>

<p>
The proof is from the snoop Extended logs. 
</p>

<div class="org-src-container">
<pre class="src src-sh">QCA Debug Logs:
Log ID: OTA LE CTRL RX PDU
Log Format: FMT_PACKET
Log Level: LOG_HIGH
TimeStamp: <span style="color: #a45bad;">0x0a142204</span>
Length: <span style="color: #a45bad;">0x0005</span>
LE Ctrl Rx PDU Info
Handle: <span style="color: #a45bad;">3</span>
TxACK Req: <span style="color: #a45bad;">0</span>
PDU Length: <span style="color: #a45bad;">1</span>
LE LL:
Control Pkt: LL_START_ENC_REQ
QCA Debug Logs:
Log ID: OTA LE CTRL TX PDU
Log Format: FMT_PACKET
Log Level: LOG_HIGH
TimeStamp: <span style="color: #a45bad;">0x0a142216</span>
Length: <span style="color: #a45bad;">0x0009</span>
LE Ctrl Tx PDU Info
Handle: <span style="color: #a45bad;">3</span>
TxACK Req: <span style="color: #a45bad;">0</span>
PDU Length: <span style="color: #a45bad;">1</span>
LE LL:
Control Pkt: LL_START_ENC_RSP
EnQ TimeStamp: <span style="color: #a45bad;">0x0a142213</span>
QCA Debug Logs:
Log ID: LOG_ID_LLM_LE_ENC_SM
Log Format: FMT_PACKET
Log Level: LOG_HIGH
TimeStamp: <span style="color: #a45bad;">0x0a142269</span>
Length: <span style="color: #a45bad;">0x0004</span>
LE Encr SM
NewState: CMs_LE_ENCR_W4_START_ENC_RSP_I
Event: CMeLE_ENCR_EVENT_RX_START_ENC_REQ
Handle: <span style="color: #a45bad;">3</span>
CurrState: CMs_LE_ENCR_W4_START_ENC_REQ 
</pre>
</div>

<p>
After this there are no more LL PDUs exchanged and there is Connection
Timeout. 
</p>

<p>
From the Peripheral side it seems there is some timing issue with
Encryption start hence when there is delay there is no issue. 
</p>

<p>
we suggested to set set BLE_DELAY_REQUEST_ENC to TRUE. and thus Encryption
proceedure will be initiated by DUT not from remote side. 
</p>

<p>
there is timing case, if we allow Peripheral to initiated Encryption.
</p></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Fu Yajun</p>
<p class="date">Created: 2018-08-12 Sun 12:18</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>QC平台知识库 for BT codec issue for general issue Android N Android O</title>
<!-- 2019-04-11 Thu 13:52 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Fu Yajun" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css" />
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">QC平台知识库 for BT codec issue for general issue Android N Android O</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Burn Image</a>
<ul>
<li><a href="#sec-1-1">1.1. Flash QRD</a></li>
<li><a href="#sec-1-2">1.2. Update an Image part</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Factory Test</a>
<ul>
<li><a href="#sec-2-1">2.1. BT Config</a></li>
<li><a href="#sec-2-2">2.2. 工程模式下写入和读取BD  ADDR</a></li>
</ul>
</li>
<li><a href="#sec-3">3. 高通处理器规格表</a></li>
<li><a href="#sec-4">4. Snapdragon Naming Update</a></li>
<li><a href="#sec-5">5. Slimbus</a>
<ul>
<li><a href="#sec-5-1">5.1. Architecture</a></li>
<li><a href="#sec-5-2">5.2. Turn on logs</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Uart ipc logs</a></li>
<li><a href="#sec-7">7. BT</a>
<ul>
<li><a href="#sec-7-1">7.1. Split A2DP Common feature Turn On/Off</a></li>
<li><a href="#sec-7-2">7.2. Disable BT Soc Logging</a></li>
<li><a href="#sec-7-3">7.3. QDID Listings</a></li>
<li><a href="#sec-7-4">7.4. APQ8909(WCN36XX)</a></li>
<li><a href="#sec-7-5">7.5. Enable/disable Bluetooth</a></li>
<li><a href="#sec-7-6">7.6. Power Class Adjustment</a></li>
<li><a href="#sec-7-7">7.7. change the BT MAC address</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Pronto(WCN36XX)</a>
<ul>
<li><a href="#sec-8-1">8.1. WCN36x0 Architecture</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Burn Image</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Flash QRD</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Steps:
</p>
<div class="org-src-container">

<pre class="src src-sh">adb root
adb reboot-bootloader
pushd \\network_path
python fastboot_complete.py
[Wait for fastboot build download finish]
fastboot reboot
</pre>
</div>

<p>
download QCN:
</p>

<pre class="example">
adb shell setprop persist.radio.multisim.config ssss
</pre>

<p>
down完QCN以后，然后手机会reboot， 如果没识别的话，你就发这个命令下去 再reboot一下.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Update an Image part</h3>
<div class="outline-text-3" id="text-1-2">
<p>
command format: <b>fastboot.exe flash bluetooth_a abl.elf</b>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">part name(Android P)</th>
<th scope="col" class="left">file name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">abl_a</td>
<td class="left">abl.elf</td>
</tr>

<tr>
<td class="left"><b>bluetooth_a</b></td>
<td class="left">BTFW.bin</td>
</tr>

<tr>
<td class="left"><b>boot_a</b></td>
<td class="left">boot.img</td>
</tr>

<tr>
<td class="left">cmnlib64_a</td>
<td class="left">cmnlib64.mbn</td>
</tr>

<tr>
<td class="left">cmnlib_a</td>
<td class="left">cmnlib.mbn</td>
</tr>

<tr>
<td class="left">devcfg_a</td>
<td class="left">devcfg.mbn</td>
</tr>

<tr>
<td class="left">dsp_a</td>
<td class="left">dspso.bin</td>
</tr>

<tr>
<td class="left">hyp_a</td>
<td class="left">hyp.mbn</td>
</tr>

<tr>
<td class="left">keymaster_a</td>
<td class="left">km4.mbn</td>
</tr>

<tr>
<td class="left">logfs</td>
<td class="left">logfs_ufs_8mb.bin</td>
</tr>

<tr>
<td class="left">logfs</td>
<td class="left">logfs_ufs_8mb.bin</td>
</tr>

<tr>
<td class="left">mdtp_a</td>
<td class="left">mdtp.img</td>
</tr>

<tr>
<td class="left">modem_a</td>
<td class="left">NON-HLOS.bin</td>
</tr>

<tr>
<td class="left">pmic_a</td>
<td class="left">pmic.elf</td>
</tr>

<tr>
<td class="left">rpm_a</td>
<td class="left">rpm.mbn</td>
</tr>

<tr>
<td class="left"><b>system_a</b></td>
<td class="left">system.img</td>
</tr>

<tr>
<td class="left">persist</td>
<td class="left">persist.img</td>
</tr>

<tr>
<td class="left">userdata</td>
<td class="left">userdata.img</td>
</tr>

<tr>
<td class="left">storsec</td>
<td class="left">storsec.mbn</td>
</tr>

<tr>
<td class="left">mdtpsecapp</td>
<td class="left">mdtpsecapp.mbn</td>
</tr>

<tr>
<td class="left">tz_a</td>
<td class="left">tz_a.mbn</td>
</tr>

<tr>
<td class="left">vendor_a</td>
<td class="left">vendor.img</td>
</tr>

<tr>
<td class="left">xbl_a</td>
<td class="left">xbl.elf</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Factory Test</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> BT Config</h3>
<div class="outline-text-3" id="text-2-1">
<p>
For Android O, 先在UI上把BT关掉然后执行
</p>
<pre class="example">
wdsdaemon -su
</pre>

<p>
然后是btconfig。
</p>

<div class="org-src-container">

<pre class="src src-sh">adb root
adb shell setprop qcom.bluetooth.soc pronto
adb shell setprop ro.qualcomm.bt.hci_transport smd
wdsdaemon -su (no need for Pronto)
</pre>
</div>

<p>
open another cmd window
</p>

<div class="org-src-container">

<pre class="src src-sh">btconfig /dev/smd3 rawcmd 0x03 0x0003 (HCI Reset) 
btconfig /dev/smd3 rawcmd 0x06 0x03 （Enter Test Mode进入测试模式） 
btconfig /dev/smd3 rawcmd 0x03 0x05 0x02 0x00 0x02 （Auto Accept All Connections自动连接） 
btconfig /dev/smd3 rawcmd 0x03 0x1A 0x03 （Page Inquiry Scans按页扫描） 
btconfig /dev/smd3 rawcmd 0x03 0x20 0x00 （Disable Authentication取消认证） 
btconfig /dev/smd3 rawcmd 0x03 0x22 0x00 （Disable Encryption取消加密）
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> 工程模式下写入和读取BD  ADDR</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-sh">#Write BD ADDRR
btconfig /dev/smd3 rawcmd 0x3f 000b 0x01 0x02 0x06 0x00 0x55 0x77 0x77 0x88 0x00

SOC is WCN
Done intiailizing fd = /dev/smd3
RAW HCI command: ogf 0x3f ocf 0xb
Params: 0x1 0x2 0x6 0x0 0x55 0x77 0x77 0x88 0x0
SEND -&gt; dump :  0b fc 09 01 02 06 00 55 77 77 88 00
Other event received, Breaking
RECV &lt;- dump :  ff 0a 0b 01 02 06 00 55 77 77 88 00

#Read BD ADDDR
btconfig /dev/smd3 rawcmd 0x04 0x0009

SOC is WCN
Done intiailizing fd = /dev/smd3
RAW HCI command: ogf 0x4 ocf 0x9
Params:
SEND -&gt; dump :  09 10 00
Other event received, Breaking
RECV &lt;- dump :  0e 0a 01 09 10 00 00 55 77 77 88 00
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 高通处理器规格表</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="http://www.mydrivers.com/zhuanti/tianti/01/index_gaotong.html">http://www.mydrivers.com/zhuanti/tianti/01/index_gaotong.html</a>
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Snapdragon Naming Update</h2>
<div class="outline-text-2" id="text-4">

<div class="figure">
<p><img src="../images/2018/2018080201.png" alt="2018080201.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Slimbus</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Architecture</h3>
<div class="outline-text-3" id="text-5-1">

<div class="figure">
<p><img src="../images/2018/2018080101.jpg" alt="2018080101.jpg" />
</p>
</div>
</div>
</div>


<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Turn on logs</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">

<pre class="src src-sh">adb root
adb wait-for-device remount
adb shell echo -n "file btfm_slim_codec.c +pf" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file btfm_slim.c +pf" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file btfm_slim_wcn3990.c +pf" "&gt;" /sys/kernel/debug/dynamic_debug/control

#Important Logs for SCO issue.
071376 07-06 20:51:13.035 D/btfm_slim_dai_hw_params( 0): dai-&gt;name = btfm_bt_sco_a2dp_slim_rx DAI-ID 2 rate 16000 num_ch 1  
071401 07-06 20:51:13.043 I/btfm_slim_enable_ch( 0): slim_connect_sink(port: 16, ch: 157)  
071567 07-06 20:51:13.102 D/btfm_slim_dai_prepare( 0): dai-&gt;name: btfm_bt_sco_slim_tx, dai-&gt;id: 1, dai-&gt;rate: 16000  
071587 07-06 20:51:13.106 I/btfm_slim_chrk_enable_port( 0): programming SCO Tx with reg_val 3 to reg 0x50  
071593 07-06 20:51:13.107 I/btfm_slim_enable_ch( 0): slim_connect_src(port: 0, ch: 161) 
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">adb shell echo -n "file bluetooth-power.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file msm_serial_hs.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file slim-msm-ctrl.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file slim-msm-ngd.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file slim-msm.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file btfm_slim_codec.c +pf" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file btfm_slim.c +pf" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file btfm_slim_wcn3990.c +pf" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file q6adm.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file q6afe.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file q6asm.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file q6voice.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control 
adb shell echo -n "file soc-dapm.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file msm-pcm-voip-v2.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control 
adb shell echo -n "file msm-pcm-routing-v2.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file msm-pcm-voice-v2.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control 
adb shell echo -n "file msm-pcm-q6-v2.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file msm-dai-q6-v2.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file msmcobalt.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
adb shell echo -n "file voice_svc.c +p" "&gt;" /sys/kernel/debug/dynamic_debug/control
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Uart ipc logs</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-sh">&lt;for SDM845 UART IPC&gt; 
&gt; cat /d/ipc_logging/898000.qcom,qup_uart_misc/log_cont &gt;&gt; /sdcard/uart_misc.ipc &amp; 
&gt; cat /d/ipc_logging/898000.qcom,qup_uart_pwr/log_cont &gt;&gt; /sdcard/uart_pwr.ipc &amp; 
&gt; cat /d/ipc_logging/898000.qcom,qup_uart_tx/log_cont &gt;&gt; /sdcard/uart_tx.ipc &amp; 
&gt; cat /d/ipc_logging/898000.qcom,qup_uart_rx/log_cont &gt;&gt; /sdcard/uart_rx.ipc &amp;
</pre>
</div>

<p>
一般客户在sdm845上都是用898000这个uart连接BT， 所以上面路径就可以.
</p>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> BT</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Split A2DP Common feature Turn On/Off</h3>
<div class="outline-text-3" id="text-7-1">
<ol class="org-ol">
<li>Set “AUDIO_FEATURE_ENABLED_SPLIT_A2DP := false” in
“hardware/qcom/audio/configs/sdmxxx/sdmxxx.mk” then build software.
</li>

<li>File case to Audio team to get the corresponding non-split A2DP
&lt;audio_policy_configuration.xml&gt; file for your platform
</li>

<li>Run the following commands. 

<div class="org-src-container">

<pre class="src src-sh">adb push audio_policy_configuration.xml  /system/etc/audio_policy_configuration.xml
adb shell setprop persist.bt.enable.splita2dp false
adb shell setprop persist.vendor.bt.enable.splita2dp false  #new add.
adb shell setprop persist.bt.a2dp_offload_cap false
adb shell setprop persist.vendor.bt.a2dp_offload_cap false
adb shell sync
adb reboot
</pre>
</div>
</li>
</ol>
</div>
</div>



<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> Disable BT Soc Logging</h3>
<div class="outline-text-3" id="text-7-2">
<p>
To disable SoC logging please make the below change @
vendor/qcom/proprietary/bluetooth/hidl_transport/bt/1.0/default/patch_dl_manager.cpp? 
</p>

<div class="org-src-container">

<pre class="src src-c++">void PatchDLManager::EnableControllerLog() 
{ 
#ifdef USER_DEBUG 
  // value at cmd[5]: 1 - to enable, 0 - to disable 
  cmd[5] = 0x00; // please change it to 0 
#else 

    ......
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> QDID Listings</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Stack and Profile

<p>
<a href="https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=21772">https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=21772</a>
</p>
</li>

<li>MSM™ chipset

<p>
<a href="https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=20783">https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=20783</a>
</p>

<p>
(for WCN3620)
<a href="https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=21332">https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=21332</a>
</p>

<p>
(for WCN3660, WCN3680)
<a href="https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=18867">https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=18867</a>
</p>
</li>

<li>QCA chipset

<ul class="org-ul">
<li>Controller

<p>
<a href="https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=22591">https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=22591</a>
</p>
</li>

<li>RF

<p>
<a href="https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=22590">https://www.bluetooth.org/tpg/QLI_viewQDL.cfm?qid=22590</a>
</p>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> APQ8909(WCN36XX)</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>Bluetooth/FM HCI-SMD Interface 


<div class="figure">
<p><img src="../images/2018/2018080102.png" alt="2018080102.png" />
</p>
</div>
</li>

<li>Between cCPU and aCPU

<ul class="org-ul">
<li>Two SMD channels are used for Bluetooth HCI commands and events, HCI ACL
data transfers
</li>

<li>One SMD channel for FM control commands and events
</li>

<li>One SMD channel for the WCN-SS debug logging shared by WLAN, Bluetooth,
and FM
</li>
</ul>
</li>

<li>Property <code>ro.qualcomm.bt.hci_transport: smd</code> is set only for PRONTO. 
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> Enable/disable Bluetooth</h3>
<div class="outline-text-3" id="text-7-5">
<p>
one way to enable/disable BT with adb shell. It is just same as operation from GUI.
Details is as follows:
</p>

<div class="org-src-container">

<pre class="src src-sh">adb shell service call
service: No code specified for call
Usage: service [-h|-?]
       service list
       service check SERVICE
       service call SERVICE CODE [i32 N | i64 N | f N | d N | s16 STR ] ...
Options:
   i32: Write the 32-bit integer N into the send parcel.
   i64: Write the 64-bit integer N into the send parcel.
   f:   Write the 32-bit single-precision number N into the send parcel.
   d:   Write the 64-bit double-precision number N into the send parcel.
   s16: Write the UTF-16 string STR into the send parcel.
</pre>
</div>

<p>
The <code>CODE</code> means sequence number of function in the AIDL file: 
</p>

<p>
frameworks/base/core/java/android/bluetooth/IBluetoothManager.aidl
</p>
<div class="org-src-container">

<pre class="src src-c++">interface IBluetoothManager
{
      IBluetooth registerAdapter(in IBluetoothManagerCallback callback);
      void unregisterAdapter(in IBluetoothManagerCallback callback);
      void registerStateChangeCallback(in IBluetoothStateChangeCallback callback);
      void unregisterStateChangeCallback(in IBluetoothStateChangeCallback callback);
      boolean isEnabled();
      boolean enable(String packageName);
      boolean enableNoAutoConnect(String packageName);
      boolean disable(String packageName, boolean persist);
     int getState();
      IBluetoothGatt getBluetoothGatt();
   
            boolean bindBluetoothProfileService(int profile, IBluetoothProfileServiceConnection proxy);
      void unbindBluetoothProfileService(int profile, IBluetoothProfileServiceConnection proxy);
   
            String getAddress();
      String getName();
      boolean factoryReset();
   
            boolean isBleScanAlwaysAvailable();
      int updateBleAppCount(IBinder b, boolean enable, String packageName);
      boolean isBleAppPresent();
}
</pre>
</div>

<p>
Since Android N and Android O has different interface, there are difference command.
</p>

<div class="org-src-container">

<pre class="src src-sh">adb shell service call bluetooth_manager 8
adb shell service call bluetooth_manager 10
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">adb shell service call bluetooth_manager 6 s16 "com.android.bluetooth" #Enable
adb shell service call bluetooth_manager 8 s16 "com.android.bluetooth" #Disablle
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6"><span class="section-number-3">7.6</span> Power Class Adjustment</h3>
<div class="outline-text-3" id="text-7-6">
<p>
for pronto, power class can  be changed in the source code. 
</p>

<p>
@vendor/qcom/proprietary/bluetooth/hidl_transport/bt/1.0/default/nvm_tags_manager.cpp
</p>

<div class="org-src-container">

<pre class="src src-c++">98    /* Tag 36 */ /* External Power Configuration */
99    { /* Opcode */       0x0b,0xfc,
100      /* Total Len */    0x0F,
101      /* NVM CMD */      NVM_ACCESS_SET,
102      /* Tag Num */      0x24,
103      /* Tag Len */      0x0C,
104      /* Tag Value */    0xFF, 0x03, 0x07, 0x09, 0x09, 0x09, 0x00, 0x00,
105                         0x09, 0x09, 0x04, 0x00
106    },
</pre>
</div>

<p>
for Cheroke, we should change the value in the crnv21.bin file. 
</p>
</div>
</div>

<div id="outline-container-sec-7-7" class="outline-3">
<h3 id="sec-7-7"><span class="section-number-3">7.7</span> change the BT MAC address</h3>
<div class="outline-text-3" id="text-7-7">
<ol class="org-ol">
<li>Please use following ADB command to set the BD address. 

<pre class="example">
setprop persist.service.bdroid.bdaddr &lt;BD address&gt;.
</pre>
</li>

<li>Make sure the changes take effect

<pre class="example">
getprop persist.service.bdroid.bdaddr
</pre>
</li>

<li>Turn OFF and Turn ON BT 
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Pronto(WCN36XX)</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> WCN36x0 Architecture</h3>
<div class="outline-text-3" id="text-8-1">

<div class="figure">
<p><img src="../images/2018/2018080103.png" alt="2018080103.png" />
</p>
</div>

<p>
To update WCNSS firmware images during debugging/development stage
</p>

<div class="org-src-container">

<pre class="src src-sh">adb shell mount –o remount –w /firmware
adb push {firmware images} /firmware/image
adb shell sync;reboot
</pre>
</div>


<div class="figure">
<p><img src="../images/2018/2018080104.png" alt="2018080104.png" />
</p>
<p><span class="figure-number">Figure 5:</span> WCN-SS High-Level Software Diagram</p>
</div>

<ul class="org-ul">
<li>Device Adaptation Layer (DAL)

<ul class="org-ul">
<li>DAL is a SW framework to provide the common API for the platform agnostic
</li>

<li>A common shim layer that provides DALs access to the OS services in a way
that is OS neutral
</li>

<li>The implementation of the DALSysis OS dependent however that is
transparent to the DALSysusers
</li>

<li>Simple and efficient, scalable to the environment
</li>

<li>It decouples the stacks from the low level microkernel running on WCNSS
cCPU
</li>

<li>DALSys provides the basic necessary OS services that the connectivity
software need: DAL interrupt controller, DAL Timer, and DAL timetick
</li>
</ul>
</li>

<li>CoreBSP –DALSys / REX

<ul class="org-ul">
<li>DALSys

<ul class="org-ul">
<li>A common shim layer that provides DAL access to the OS services in a
way that is OS-neutral
</li>

<li>The implementation of the DALSys is OS-dependent; however, that is
transparent to DALSysusers.
</li>

<li>Decoupling the stacks from the low-level microkernel running on the
cCPU can help maximize portability of WLAN, Bluetooth, and FM modules.
</li>
</ul>
</li>

<li>Kernel Services provided by DALSys

<ul class="org-ul">
<li>Synchronization (interrupt, mutexor critical sections)
</li>

<li>Events and callbacks
</li>

<li>Memory and cache operations
</li>

<li>Physical memory manipulation
</li>

<li>Shared execution contexts Workloops(shared threads)
</li>
</ul>
</li>

<li>The underlying RTOS for DALSysis REX

<ul class="org-ul">
<li>REX is small (~4K), highly predictable (executed code is well defined),
low latency in interrupt processing and can bring all the services that
WCNSS needs.
</li>
</ul>
</li>

<li>The core BT SOC software functionalities are divided in below major
Software modules.

<ul class="org-ul">
<li>HIF TASK

<p>
This task is responsible for providing the HCI interface between BT
Host software and BT Firmware. It implements the HCI driver for the
various transports like UART and or SMD and provides a complete
abstract HCI Statemachine (using Platform Abstraction Layer -PFAL)
which can handle the HOST/BTSOC HCI commands/events and ACL data over
the HCI transport driver.
</p>
</li>

<li>LLM TASK

<p>
This is the core of the Bluetooth Firmware which is responsible for
maintaining the Bluetooth Link and its control. This task is
responsible for creating and maintaining all logical links like ACL-C,
SCO/eSCO and implements Link Manager Protocol of BR/EDR and Link Layer
Protocol for LE physical links. It interfaces mainly with HIF using
message queues to exchange data and operate on the commands and
responses.
</p>
</li>

<li>Audio Codec Subsystem

<p>
This module runs under ISR context and handles LPASS, LC and Timer
interrupts to provide the encoding/decoding the voice PCM data to be
RX/TX over the SCO/eSCO logical transports. It supports of CVSD/MSBC
(voice) and SBC (music) decoder. At present, this module mainly targets
the Voice and FM data transfer to and from LPASS using CMEM memory
controller.
</p>
</li>

<li>BT Scheduler/Dispatcher

<p>
The core module to dispatch and schedule BT Baseband packets delivered
from LLM or HIF task. This module runs in ISR context and mainly
handles the LC hardware interrupts to process and schedule next packet
to transmit. For this scheduling, it manages various priority queues
for all Bluetooth Physical Channels (PAGE, INQUIRY, BR, EDR etc.). The
scheduling is always driven based on Bluetooth Native clock and with
slot intervals (half or full) of 625us. The packets to be transmitted
can be queued by various modules along with their priority. On every
slot based interrupts, the scheduler de queues them and readies it for
TX operation.
</p>
</li>

<li>LC State Machine

<p>
This interface is mainly responsible to drive and control the BT LC
hardware block or we can say that it is software Link Controller. It
tries to mimic the LC hardware states and allows the BT firmware to
program and access the LC registers required for any BT RF TX and TX
and to know the current Hardware LC states. It runs under real time
bound interrupts like Pre-slot, LC Done, CLK Comparator to provide the
LC functionality to the BT firmware. The LC hardware block provides
various memory addressable LC registers which can be configured to get
the Baseband Data transfer. The LC block directly connects to Bluetooth
Baseband Modem and radio interface. 
</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Fu Yajun</p>
<p class="date">Created: 2019-04-11 Thu 13:52</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.0.50.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
